<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Bell Strike Trigger</title>
    <style>
      body {
        background-color: #2c3e50;
        margin: 0;
        padding: 20px;
        font-family: sans-serif;
        color: #ecf0f1;
      }
      .panel {
        background: #34495e;
        padding: 20px;
        border-radius: 8px;
        display: inline-block;
      }
      select, button {
        margin: 5px 0;
        padding: 6px 10px;
        font-size: 14px;
      }
      label {
        display: block;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="panel">
      <h3>Rock Code Selector</h3>

      <label for="codeX">codeA (0~2)</label>
      <select id="codeX">
        <option value="0">0</option>
        <option value="1">1</option>
        <option value="2">2</option>
      </select>

      <label for="codeY">codeH (0~2)</label>
      <select id="codeY">
        <option value="0">0</option>
        <option value="1" selected>1</option>
        <option value="2">2</option>
      </select>

      <br />
      <!-- ✅ 코드만 설정하는 버튼 -->
      <button onclick="applyCode()">Apply Code Only</button>
      <!-- ✅ 현재 코드로 신호 + PC 햅틱 -->
      <button onclick="sendSignal()">Send Signal</button>
      <!-- ✅ HMD Visual Cue 토글 버튼 -->
      <button onclick="toggleCue()">Toggle Visual Cue</button>

      <p id="status"></p>
    </div>

    <script>
      async function applyCode() {
        const codeX = parseInt(document.getElementById("codeX").value);
        const codeY = parseInt(document.getElementById("codeY").value);

        try {
          const res = await fetch("/set_code", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ codeX: codeX, codeY: codeY }),
          });

          const data = await res.json();
          console.log("set_code:", data);

          const s = document.getElementById("status");
          s.textContent =
            "Code set → (" + data.codeX + "," + data.codeY + ")";
        } catch (err) {
          console.error(err);
          document.getElementById("status").textContent =
            "Error (set_code): " + err;
        }
      }

      async function sendSignal() {
        const codeX = parseInt(document.getElementById("codeX").value);
        const codeY = parseInt(document.getElementById("codeY").value);

        try {
          // 1) 먼저 codeX, codeY 설정
          const setRes = await fetch("/set_code", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ codeX: codeX, codeY: codeY }),
          });
          const setData = await setRes.json();
          console.log("set_code (from sendSignal):", setData);

          // 2) 그 다음 현재 코드로 Press + Haptic 동시에
          const [pressRes, hapticRes] = await Promise.all([
            fetch("/press_button", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({}), // press_button은 current_code만 사용
            }),
            fetch("/trigger_haptic", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({}),
            }),
          ]);

          const pressData = await pressRes.json();   // { status, seq, codeX, codeY }
          const hapticData = await hapticRes.json(); // { status, haptic_seq }

          const s = document.getElementById("status");
          s.textContent =
            "Signal Sent | seq=" +
            pressData.seq +
            " | code=(" +
            pressData.codeX +
            "," +
            pressData.codeY +
            ")" +
            " | haptic_seq=" +
            hapticData.haptic_seq;
        } catch (err) {
          console.error(err);
          document.getElementById("status").textContent =
            "Error (sendSignal): " + err;
        }
      }
      
      // Visual Cue 토글 요청
      async function toggleCue() {
        try {
          const res = await fetch("/toggle_cue", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({}),
          });

          const data = await res.json();
          console.log("toggle_cue:", data);

          const s = document.getElementById("status");
          s.textContent = "Cue toggled | cue_seq=" + data.cue_seq;
        } catch (err) {
          console.error(err);
          document.getElementById("status").textContent =
            "Error (toggleCue): " + err;
        }
      }
    </script>
  </body>
</html>
